worker_processes auto;

events {
    worker_connections 1024;
}

http {

    # -----------------------------
    # Upstreams
    # -----------------------------
    upstream microservice_get {
        server ms-payroll-employees-get:8080;
    }

    upstream microservice_post {
        server ms-payroll-employees-post:8080;
    }

    upstream microservice_put {
        server ms-payroll-employees-put:8080;
    }

    upstream microservice_delete {
        server ms-payroll-employees-delete:8080;
    }

    server {
        listen 80;

        # -----------------------------
        # Health endpoint
        # -----------------------------
        location /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "OK";
        }

        # -----------------------------
        # Global error handling
        # -----------------------------
        proxy_intercept_errors on;

        error_page 502 503 504 =503 /service-unavailable;

        location /service-unavailable {
            internal;
            default_type application/json;
            add_header Retry-After 30;
            return 503 '{"error":"Payroll service temporarily unavailable"}';
        }

        # -----------------------------
        # API routing (by HTTP verb)
        # -----------------------------
        location / {

            proxy_connect_timeout 3s;
            proxy_read_timeout 5s;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            if ($request_method = GET) {
                proxy_pass http://microservice_get;
                break;
            }

            if ($request_method = POST) {
                proxy_pass http://microservice_post;
                break;
            }

            if ($request_method = PUT) {
                proxy_pass http://microservice_put;
                break;
            }

            if ($request_method = DELETE) {
                proxy_pass http://microservice_delete;
                break;
            }

            # Reject unsupported HTTP methods
            if ($request_method ~* "(OPTIONS|PATCH|CONNECT)") {
                return 405;
            }

            # All other HTTP methods
            return 404;
        }
    }
}
