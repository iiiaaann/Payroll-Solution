worker_processes auto;

events {
    worker_connections 1024;
}

http {

    resolver 127.0.0.11 valid=10s;

    access_log /dev/stdout;
    error_log  /dev/stderr warn;

    upstream microservice_get {
        server ms-payroll-employees-get:8080;
    }

    upstream microservice_post {
        server ms-payroll-employees-post:8080;
    }

    upstream microservice_put {
        server ms-payroll-employees-put:8080;
    }

    upstream microservice_delete {
        server ms-payroll-employees-delete:8080;
    }

    map $request_method $upstream_service {
        GET     microservice_get;
        POST    microservice_post;
        PUT     microservice_put;
        DELETE  microservice_delete;
        default "";
    }

    server {
        listen 80;
        server_name _;

        location /health {
            access_log off;
            return 200 "OK";
        }

        proxy_connect_timeout 3s;
        proxy_read_timeout 5s;
        proxy_send_timeout 5s;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_intercept_errors on;

        error_page 502 503 504 =503 /service-unavailable;

        location /service-unavailable {
            internal;
            default_type application/json;
            add_header Retry-After 30;
            return 503 '{"error":"Payroll service temporarily unavailable"}';
        }

        location / {
            if ($upstream_service = "") {
                return 405;
            }

            proxy_pass http://$upstream_service;
        }
    }
}
